<!DOCTYPE html>
<html lang="ru">

<head>
    <title>Waffle Devlog 2</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>
    <meta name="author" content="Nikita Nothing">

    <meta name="theme-color" content="#78E2A0">

    
    
    <meta name="title" content="Waffle Devlog 2">
    <meta name="description" content="Blah. Things I&#x27;ve done this week (2023-04-10—2023-04-14).">
    <meta name="image" content="https://trillnepill.github.io/blog//you_cant_escape_from_reality_450x450.png">

    
        <meta name="keywords" itemprop="tags" content="devlog">
    

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://trillnepill.github.io/blog/devlog-02/">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Waffle Devlog 2">
    <meta property="og:description" content="Blah. Things I&#x27;ve done this week (2023-04-10—2023-04-14).">
    <meta property="og:image" content="https://trillnepill.github.io/blog//you_cant_escape_from_reality_450x450.png">
    <meta property="og:locale" content="ru">

    
        <meta property="article:published_time" content="2023-04-14">
    

    
        
            <meta property="article:tag" content="devlog">
        
    

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta property="twitter:domain" content="ihatereality.space">
    <meta property="twitter:url" content="https://trillnepill.github.io/blog/devlog-02/">
    <meta name="twitter:title" content="Waffle Devlog 2">
    <meta name="twitter:description" content="Blah. Things I&#x27;ve done this week (2023-04-10—2023-04-14).">
    <meta name="twitter:image" content="https://trillnepill.github.io/blog//you_cant_escape_from_reality_450x450.png">
    <meta name="twitter:creator" content="maybewaffle">



    
    <link rel="stylesheet" href="https://trillnepill.github.io/blog/style.css">
    <link rel="stylesheet" href="https://trillnepill.github.io/blog/color/green.css">

    <link rel="stylesheet" href="https://trillnepill.github.io/blog/font-hack.css">


    
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://trillnepill.github.io/blog/rss.xml">
    
        <link rel="shortcut icon" type="image&#x2F;png" href="/you_cant_escape_from_reality_128x128.png">
    
    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://trillnepill.github.io/blog/" style="text-decoration: none;">
                    <div class="logo">
                            nothingd3v
                        </div>
                </a>
            </div>
        </div>

        <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://trillnepill.github.io/blog//about">about</a></li>
            
                <li><a href="https://github.com/trillnepill/blog" target="_blank" rel="noopener noreferrer">source</a></li>
            </ul>
        </nav>
    
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://trillnepill.github.io/blog/devlog-02/">Waffle Devlog 2</a></h1>
    
        <div class="post-meta-inline">
            
    <span class="post-date">
            2023-04-14
        
    </span>

            
    <span class="post-read-time">
        :: 4 min read
    </span>


            <!-- TODO: rethink how tags look -->
            <br>
            
        <span class="post-tags-inline"><a class="post-tag" href="https://trillnepill.github.io/blog/tags/devlog/">#devlog</a></span>
    
        </div>
    


        
        <div class="post-content">
            <p>Blah. Things I’ve done this week (2023-04-10—2023-04-14). This is mostly a log for <em>myself</em> so that I remember that I did things, but you may be interested in reading it too, for whatever reason.</p>
<span id="continue-reading"></span><h1 id="tagged-pointer-rewrite">Tagged Pointer Rewrite<a class="zola-anchor" href="#tagged-pointer-rewrite" aria-label="Anchor link for: tagged-pointer-rewrite">⌗</a></h1>
<p>This is my main work of this week — rewriting tagged pointer implementation in <code>rustc</code> (<a href="https://github.com/rust-lang/rust/pull/110243">rust/110243</a>).</p>
<p>To be honest, tagged pointers probably deserve an article of their own, with all the bits, tricks and bit tricks
(please do tell me if you think I should write it/you want to read it).</p>
<p>TL;DR is that “tagged pointers” is a technique of packing a pointer with a few (typically 2-3) bits of additional information (tag).</p>
<p>Since it needs to perform bit tricks on the pointer value,
original implementation used <code>NonZeroUsize</code> as the inner type of the tagged pointer type.
This technically works, but is generally a bad idea.
You are <strong>really</strong> not supposed to store pointers as integers.</p>
<p>I’ve rewritten the implementation using the new <a href="https://doc.rust-lang.org/std/ptr/index.html#provenance">“strict provenance” APIs</a> and a <code>NonNull</code> pointer as the inner type, 
doing other code &amp; documentation improvements along the way.
In my opinion the resulting code is quite nice and cute, I like it.</p>
<p>Along the way I also discovered a missed optimization case in LLVM (<a href="https://github.com/llvm/llvm-project/issues/62093">llvm/62093</a>)
and tried to fix it on the rust side using scottmcm’s suggestion
(<a href="https://github.com/rust-lang/rust/pull/110318">rust/110318</a>, although it looks like this is doing more harm than good, this PR is likely to be closed).
I also learned a lot about tagged pointers and some stuff about tools around LLVM.</p>
<p>Overall, proud of this work!</p>
<h1 id="sharing-bytes">Sharing bytes<a class="zola-anchor" href="#sharing-bytes" aria-label="Anchor link for: sharing-bytes">⌗</a></h1>
<p>This builds on top of the <a href="https://ihatereality.space/devlog-01/#yeet-owningref">yeeting owning ref</a> from the previous devlog.
Originally I stored <code>owner: Box&lt;dyn Send + Sync&gt;</code>, which works, but makes it impossible to clone the “<code>OwnedSlice</code>”.
This is not the biggest deal, given that you can wrap one <code>OwnedSlice</code> in another (and still get the same access performance)…
But some <code>rustc</code> uses become nicer with the ability to clone/re-slice an <code>OwnedSlice</code>,
so in <a href="https://github.com/rust-lang/rust/pull/110145">rust/110145</a> I try to support that by storing <code>owner: Arc&lt;dyn Send + Sync&gt;</code> instead.
The PR still needs some documentation fixes and minor adjustments, but is mostly done.</p>
<h1 id="small-stuff">Small Stuff<a class="zola-anchor" href="#small-stuff" aria-label="Anchor link for: small-stuff">⌗</a></h1>
<p>A couple of very small PRs that don’t really deserve descriptions:</p>
<ul>
<li><a href="https://github.com/rust-lang/rust/pull/110182">rust/110182</a> — <code>itertools::Either</code> instead of own impl</li>
<li><a href="https://github.com/rust-lang/rust/pull/110291">rust/110291</a> — Implement <code>Copy</code> for <code>LocationDetail</code></li>
</ul>
<p>I was also working on relaxing some bounds on <code>BTree{Set, Map}</code>,
but this turned out to be more work than I expected, so I ended up postponing that.</p>
<h1 id="stream">Stream<a class="zola-anchor" href="#stream" aria-label="Anchor link for: stream">⌗</a></h1>
<p>The stream started out with some doc changes for tagged pointers (I really wanted to finish them!)
and then I continued work on <a href="https://github.com/rust-lang/rust/pull/110061">rust/110061</a> which I’ve been working on for the last 3 streams (uhhh).
Tbh the stream was quite uneventful,
although I’ve finally made the <a href="https://github.com/rust-lang/rust/pull/110061">rust/110061</a>’s suggestion work as expected
(it now suggests to change all variable uses, not just the first one)!</p>
<p>This makes me think if the “rustc contribution” format is just bad for streams, or at least one that I can’t pull-of.
Maybe I should stop doing them, at least for the time being? idk…</p>
<h1 id="ci">CI<a class="zola-anchor" href="#ci" aria-label="Anchor link for: ci">⌗</a></h1>
<p>Just so you know, this week CI was bullying me.
I did what feels like a million “fix doc”, “fix fmt” and similar commits, UGH. Anyway-</p>
<h1 id="reviews">Reviews<a class="zola-anchor" href="#reviews" aria-label="Anchor link for: reviews">⌗</a></h1>
<p>Pull requests I’ve reviewed in this week:</p>
<ul>
<li><a href="https://github.com/rust-lang/rust/pull/110193">rust/110193</a> — Check for body owner fallibly in error reporting</li>
<li><a href="https://github.com/rust-lang/rust/pull/110315">rust/110315</a> — Add a stable MIR way to get the main function</li>
<li><a href="https://github.com/rust-lang/rust/pull/110313">rust/110313</a> — allow <code>repr(align = x)</code> on inherent methods</li>
<li><a href="https://github.com/rust-lang/rfcs/pull/3407">rust-lang/rfcs/3407</a> — “Explicit Tail Calls” RFC, I continue trying to review &amp; improve it (again, bit fun of explicit tail calls)</li>
</ul>
<h1 id="summary">Summary<a class="zola-anchor" href="#summary" aria-label="Anchor link for: summary">⌗</a></h1>
<p>Although I didn’t do that much work, working on tagged pointers was very fun and overall I’m satisfied with this week. “See” you next week!</p>

        </div>

        
        <div class="pagination">
            <div class="pagination__title">
                <span class="pagination__title-h">Thanks for reading! Read other posts?</span>
                <hr />
            </div>
            <div class="pagination__buttons">
                    <span class="button previous">
                        <a href="https://trillnepill.github.io/blog/devlog-03/">
                            <span class="button__icon">←</span>&nbsp;
                            <span class="button__text">Waffle Devlog 3</span>
                        </a>
                    </span>
                
                
                    <span class="button next">
                        <a href="https://trillnepill.github.io/blog/devlog-01/">
                            <span class="button__text">Waffle Devlog 1</span>&nbsp;
                            <span class="button__icon">→</span>
                        </a>
                    </span>
                </div>
        </div>
    
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright copyright--user"><div class="copyright"><span>© 2023 Maybe Waffle | NothingD3v</span><span class="copyright-theme"><span class="copyright-theme-sep">:: </span>Theme is based on <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a></span><span class="copyright-theme-sep">:: </span><a href="/rss.xml">rss</a></div></div>
            </div>
    </footer>
    

</div>

<!-- Tracking via https://www.goatcounter.com/ -->
<script data-goatcounter="https://ihr.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>
